name: NVO987 Full Code Validator

on:
  push:
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install validators
        run: |
          sudo apt-get update
          sudo apt-get install -y jq tidy libxml2-utils

      - name: Validate JSON files
        run: |
          echo "ğŸ” JSON validation"
          find . -type f -name "*.json" ! -path "./.git/*" | while read f; do
            echo "â†’ $f"
            jq empty "$f"
          done

      - name: Validate NDJSON files
        run: |
          echo "ğŸ” NDJSON validation"
          find . -type f -name "*.ndjson" ! -path "./.git/*" | while read f; do
            echo "â†’ $f"
            nl -ba "$f" | while read n line; do
              echo "$line" | jq empty >/dev/null
            done
          done

      - name: Validate XML files
        run: |
          echo "ğŸ” XML validation"
          find . -type f -name "*.xml" ! -path "./.git/*" | while read f; do
            echo "â†’ $f"
            xmllint --noout "$f"
          done

      - name: Validate HTML files
        run: |
          echo "ğŸ” HTML validation"
          find . -type f -name "*.html" ! -path "./.git/*" | while read f; do
            echo "â†’ $f"
            tidy -errors -q "$f" || true
          done

      - name: Check empty files
        run: |
          echo "ğŸ” Empty file check"
          find . -type f ! -path "./.git/*" | while read f; do
            if [ ! -s "$f" ]; then
              echo "âŒ Empty file: $f"
              exit 1
            fi
          done

      - name: Check required assets
        run: |
          echo "ğŸ” Required files"
          test -f avatar.png || test -f avatar.jpg
          test -f og-image.jpg
          test -f .well-known/knowledge.json

      - name: Final status
        run: echo "âœ… All files validated successfully"
